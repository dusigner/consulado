'use strict';

var CRM = require('modules/store/crm');
var validation = require('modules/store/validation');

require('modules/helpers');
require('vendors/slick');
require('vendors/jquery.validate');

//load Nitro Lib
require('vendors/nitro');

Nitro.setup(['consul-landing-aniversario'], function () {
	var self = this,
		$formNewsletter = $('#form-newsletter');

	this.calculateTimeRemaining = function(endDate) {
		var total = Date.parse(endDate) - Date.parse(new Date()),
			seconds = Math.floor( (total/1000) % 60 ),
			minutes = Math.floor( (total/1000/60) % 60 ),
			hours = Math.floor( (total/(1000*60*60)) % 24 ),
			days = Math.floor( total/(1000*60*60*24) ),
			timeRemaining = {
				'total': total,
				'days': days,
				'hours': hours,
				'minutes': minutes,
				'seconds': seconds
			};

		return timeRemaining;
	};

	this.countdown = function() {
		var endDate = '2017/7/17',
			$countdown = $('.countdown'),
			$days = $countdown.find('.countdown-days .counter'),
			$hours = $countdown.find('.countdown-hours .counter'),
			$minutes = $countdown.find('.countdown-minutes .counter'),
			$seconds = $countdown.find('.countdown-seconds .counter'),
			timeRemaining = self.calculateTimeRemaining(endDate),
			days = timeRemaining.days,
			hours = timeRemaining.hours,
			minutes = timeRemaining.minutes,
			seconds = timeRemaining.seconds;

		$days.text(days < 10 ? '0' + days : days);
		$hours.text(hours < 10 ? '0' + hours : hours);
		$minutes.text(minutes < 10 ? '0' + minutes : minutes);
		$seconds.text(seconds < 10 ? '0' + seconds : seconds);
	};

	//slider prateleira do contador
	this.init = function() {
		this.sliderProdutos();
	};

	this.sliderProdutos = function() {
		if ($(window).width() <= 992) {
			$('.imgProdutos .slider').slick({
				slidesToShow: 1,
				slidesToScroll: 1,
				asNavFor: '.infoProdutos .prateleira > ul',
				arrows: false,
				dots: true,
				centerMode: false,
				focusOnSelect: true
			});
		}
	};

	this.init();

	this.insertClient = function(data) {
		CRM.insertClient(data).done(function(res){
			if (res) {
				//exibe msg de sucesso
				$formNewsletter.fadeOut();
				$('#form-birthday .success').fadeIn();
			} else {
				//exibe msg de erro
				$('#form-birthday .error').text('Oops! Algo deu errado. Por favor, tente novamente.');
				$('#form-birthday .error').fadeIn();
			}
		});
	};

	//cadastro newsletter
	$formNewsletter.submit(function(e){
		e.preventDefault();

		var $fields = $(this).find('input[type="text"], input[type="email"]'),
			$inputName = $formNewsletter.find('input[type="text"]'),
			$inputEmail = $formNewsletter.find('input[type="email"]'),
			$btnSubmit = $(this).find('input[type="submit"]');

		validation.validate($fields, $btnSubmit)
							.done(function(){
								var data = {
									firstName: $inputName.val(),
									email: $inputEmail.val(),
									isNewsletterOptIn: true,
									newsletterType: 'aniversario2017'
								};

								$.getJSON(CRM.clientURI, {
									f: 'id,email,isNewsletterOptIn,newsletterType',
									fq: 'email:' + $inputEmail.val()
								}).done(function(res){
									if (res && res.Documents[0].isNewsletterOptIn && res.Documents[0].newsletterType) {
										//exibe msg de erro
										$('#form-birthday .error').fadeIn();
									} else {
										if (res) {
											self.insertClient(data);
										} else {
											$('#form-birthday .error').text('Oops! Algo deu errado. Por favor, tente novamente.');
											$('#form-birthday .error').fadeIn();
										}
									}
								}).fail(function(res){
									if (res.status === 404) {
										self.insertClient(data);
									} else {
										$('#form-birthday .error').text('Oops! Algo deu errado. Por favor, tente novamente.');
									}
								});
							});
	});


	//compartilhar facebook
	$('.share-facebook').click(function(e) {
		e.preventDefault();

		var url = store.isQA ? 'http://consulqa.vtexcommercestable.com.br/landing/aniversario' : 'http://loja.consul.com.br/landing/aniversario';

		window.open('https://www.facebook.com/sharer.php?u=' + url, 'sharer', 'width=626,height=436');
	});

	setInterval(self.countdown, 1000);
});