'use strict';

var CRM = require('modules/store/crm');
var validation = require('modules/store/validation');

require('modules/helpers');
require('vendors/slick');
require('vendors/jquery.validate');

//load Nitro Lib
require('vendors/nitro');

Nitro.setup(['consul-landing-aniversario'], function () {
	var self = this,
		$formNewsletter = $('#form-newsletter');

	this.scrollTo = function(element) {
		var section = $(element).attr('href'),
			top = ($(window).width() <= 768) ? ($(section).offset().top - 120) : ($(section).offset().top - 60);

		//abre section de produtos
		if (section === '#produtos') {
			$('#produtos .wrapper').slideDown(300);
			$('html, body').animate({ scrollTop: top }, 600);

			if ($(window).width() <= 768) {
				self.initSliderProdutos();
			}
		} else {
			$('html, body').animate({ scrollTop: top }, 600);
		}
	};

	this.initSliderProdutos = function() {
		$('#produtos .wrapper').slick({
			dots: true,
			swipe: true,
			slidesToShow: 1
		});
	};

	this.calculateTimeRemaining = function(endDate) {
		var total = Date.parse(endDate) - Date.parse(new Date()),
			seconds = Math.floor( (total/1000) % 60 ),
			minutes = Math.floor( (total/1000/60) % 60 ),
			hours = Math.floor( (total/(1000*60*60)) % 24 ),
			days = Math.floor( total/(1000*60*60*24) ),
			timeRemaining = {
				'total': total,
				'days': days,
				'hours': hours,
				'minutes': minutes,
				'seconds': seconds
			};

		return timeRemaining;
	};

	this.countdown = function() {
		var endDate = '2017-7-10',
			$countdown = $('.countdown'),
			$days = $countdown.find('.countdown-days .counter'),
			$hours = $countdown.find('.countdown-hours .counter'),
			$minutes = $countdown.find('.countdown-minutes .counter'),
			$seconds = $countdown.find('.countdown-seconds .counter'),
			timeRemaining = self.calculateTimeRemaining(endDate),
			days = timeRemaining.days,
			hours = timeRemaining.hours,
			minutes = timeRemaining.minutes,
			seconds = timeRemaining.seconds;

		$days.text(days < 10 ? '0' + days : days);
		$hours.text(hours < 10 ? '0' + hours : hours);
		$minutes.text(minutes < 10 ? '0' + minutes : minutes);
		$seconds.text(seconds < 10 ? '0' + seconds : seconds);
	};

	//clique nos links leva para section correspondente
	$('.header .container>div a:not(.share-facebook), #acoes-desktop .wrapper>div a:not(.share-facebook), #acoes-mobile .espiar').click(function(e){
		e.preventDefault();

		self.scrollTo($(this));
	});

	//cadastro newsletter
	$formNewsletter.submit(function(e){
		e.preventDefault();

		var $fields = $(this).find('input[type="text"], input[type="email"]'),
			$inputName = $formNewsletter.find('input[type="text"]'),
			$inputEmail = $formNewsletter.find('input[type="email"]'),
			$btnSubmit = $(this).find('input[type="submit"]');

		validation.validate($fields, $btnSubmit)
							.done(function(){
								var data = {
									firstName: $inputName.val(),
									email: $inputEmail.val(),
									isNewsletterOptIn: true
								};

								$.getJSON(CRM.clientURI, {
									f: 'id,email',
									fq: 'email:' + $inputEmail.val()
								}).done(function(res){
									if (res) {
										//exibe msg de erro
										$('#cadastro .form .error').fadeIn();
									}
								}).fail(function(res){
									if (res.status === 404) {
										CRM.insertClient(data).done(function(res){
											if (res) {
												//exibe msg de sucesso
												$formNewsletter.fadeOut();
												$('#cadastro .form .success').fadeIn();
											} else {
												//exibe msg de erro
												$('#cadastro .form .error').text('Oops! Algo deu errado. Por favor, tente novamente.');
												$('#cadastro .form .error').fadeIn();
											}
										});
									} else {
										$('#cadastro .form .error').fadeIn();
									}
								});
							});
	});

	//compartilhar facebook
	$('.share-facebook').click(function(e) {
		e.preventDefault();

		window.open('https://www.facebook.com/sharer.php?u=http://consulqa.vtexcommercestable.com.br/landing/aniversario', 'sharer', 'width=626,height=436');
	});

	setInterval(self.countdown, 1000);
});